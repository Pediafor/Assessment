# 📂 Database Setup Guide (`/db`)

This directory contains everything related to database structure and migrations for the Pediafor platform.

We support two complementary approaches:

- **Prisma ORM + Migrations** (recommended, declarative, schema-driven)
- **Raw SQL Initialization** (for manual setup, debugging, or testing outside Prisma)

## 📁 Folder Structure

```yaml
/db
├── prisma/
│   ├── schema.prisma   # Prisma schema (source of truth for models/tables)
│   ├── migrations/     # Auto-generated + manual migration files
│   └── README.md       # Guide to working with Prisma migrations
├── init.sql            # Hardcoded SQL DDL (manual DB bootstrap if needed)
└── README.md           # ← (this file)
```

---

## ⚙️ Option 1: Prisma-Driven Setup (default)

Prisma is our primary ORM and migration tool.

It handles schema evolution, ensures reproducibility across environments, and avoids "drift" between dev/prod.

### Initial Setup

```bash
cd db/prisma
npm install
```

### Generate Client

```bash
npx prisma generate
```

### Run Migrations (Dev DB)

```bash
npx prisma migrate dev --name init
```

This will:

- Create tables from `schema.prisma`
- Apply migrations in `migrations/`
- Keep a history of applied changes

### Deploy to Production

```bash
npx prisma migrate deploy
```

---

## ⚙️ Option 2: Raw SQL Bootstrap (`init.sql`)

For cases where Prisma isn’t available (e.g., debugging, running directly on Postgres), you can initialize the schema with the pure SQL file:

```bash
psql -U <user> -d <database> -f db/init.sql
```

This:

- Creates all tables, indexes, and constraints in one go
- Mirrors the schema defined in `schema.prisma`
- Useful for inspection or quick DB resets

> **Warning:**  
> Do not mix `init.sql` and Prisma migrations in the same environment without care.  
> Prefer Prisma migrations in dev/prod for consistency.

---

## 🧩 Indexes & Advanced Features

- Standard indexes and constraints are defined in `schema.prisma` (`@@index`, `@@unique`).
- Advanced indexes (GIN, ivfflat for embeddings, JSONB ops) are not auto-generated by Prisma.
- These live in manual migrations, e.g., `prisma/migrations/*_indexes/migration.sql`
- Run them manually once, then mark as resolved:

```bash
npx prisma migrate resolve --applied 20250918_indexes
```

---

## 🔑 Contributor Notes

- **Source of Truth:** `schema.prisma` is always the primary reference.
- **Do Not Edit** `init.sql` unless schema changes are finalized and synced with Prisma.

### Migrations Flow

1. Modify `schema.prisma`
2. Run `npx prisma migrate dev --name <change>`
3. Commit both `schema.prisma` and the new `migrations/` folder
4. If advanced indexes are needed → add manual migration SQL

---

## 📚 Resources

- [Prisma Migrate Docs](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Postgres JSONB Indexing](https://www.postgresql.org/docs/current/datatype-json.html)
- [pgvector](https://github.com/pgvector/pgvector)
